<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MiniSearch</title>
		<style>
			:root {
				--primary: #3b82f6;
				--primary-hover: #2563eb;
				--bg: #fcfcfd;
				--card-bg: #ffffff;
				--text-main: #111827;
				--text-muted: #6b7280;
				--url-color: #10b981;
				--border: #f3f4f6;
				--shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
				--shadow-hover: 0 10px 15px -3px rgb(0 0 0 / 0.1);
			}

			body {
				font-family:
					"Inter",
					-apple-system,
					system-ui,
					sans-serif;
				background-color: var(--bg);
				color: var(--text-main);
				margin: 0;
				line-height: 1.5;
			}

			header {
				background: var(--card-bg);
				padding: 12px 20px;
				font-size: 0.75rem;
				color: var(--text-muted);
				border-bottom: 1px solid var(--border);
				display: flex;
				justify-content: center; /* Centered for mobile */
				text-align: center;
				font-weight: 500;
			}

			main {
				max-width: 800px;
				margin: 0 auto;
				padding: 40px 16px; /* Reduced padding for mobile */
			}

			.hero-section {
				text-align: center;
				margin-bottom: 30px;
			}

			h1 {
				font-size: 2.5rem; /* Slightly smaller for mobile scaling */
				font-weight: 800;
				margin: 0;
				background: linear-gradient(135deg, #1e40af, #3b82f6);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				letter-spacing: -0.05em;
			}

			.search-container {
				position: relative;
				max-width: 650px;
				margin: 0 auto 30px;
			}

			.search-box {
				display: flex;
				background: var(--card-bg);
				border-radius: 99px;
				padding: 4px;
				border: 1px solid #d1d5db;
				box-shadow: var(--shadow);
			}

			input[type="text"] {
				flex: 1;
				border: none;
				outline: none;
				padding: 10px 16px;
				font-size: 1rem;
				border-radius: 99px;
				background: transparent;
				min-width: 0; /* Prevents overflow */
			}

			button {
				background: var(--primary);
				color: white;
				border: none;
				padding: 0 20px;
				border-radius: 99px;
				font-weight: 600;
				cursor: pointer;
			}

			.ai-summary {
				background-color: #f0f7ff;
				border: 1px solid #d0e1fd;
				padding: 18px;
				border-radius: 16px;
				margin-bottom: 24px;
			}

			.ai-summary p {
				font-size: 0.95rem;
				line-height: 1.6;
			}

			.result-card {
				background: var(--card-bg);
				padding: 20px;
				border-radius: 12px;
				border: 1px solid var(--border);
				word-wrap: break-word; /* Important for long URLs on mobile */
			}

			.result-title {
				color: #2563eb;
				font-size: 1.2rem;
				font-weight: 600;
				text-decoration: none;
			}

			.meta-footer {
				flex-wrap: wrap; /* Allows scores to wrap on tiny screens */
				gap: 10px;
			}

			/* --- Mobile Specific Adjustments --- */
			@media (max-width: 600px) {
				h1 {
					font-size: 2rem;
				}

				main {
					padding: 20px 12px;
				}

				.search-box {
					padding: 2px;
				}

				input[type="text"] {
					padding: 12px 14px;
				}

				button {
					padding: 0 16px;
				}

				header {
					font-size: 0.7rem;
				}

				.result-card {
					padding: 16px;
				}
			}
		</style>
	</head>
	<body>
		<header id="stats-header">Syncing with index...</header>
		<main>
			<div class="hero-section">
				<h1>MiniSearch</h1>
				<p style="color: var(--text-muted); margin-top: 4px; font-size: 0.9rem">
					Lightning fast Wikipedia exploration
				</p>
			</div>
			<div class="search-container">
				<div class="search-box">
					<input
						type="text"
						id="search-input"
						placeholder="Search Wikipedia..."
						autofocus
					/>
					<button onclick="performSearch()">Search</button>
				</div>
				<div
					id="results-count"
					style="margin: 8px 16px; font-size: 0.8rem; color: var(--text-muted)"
				></div>
			</div>
			<div id="results-area"></div>
		</main>

		<script>
			const input = document.getElementById("search-input");
			const resultsArea = document.getElementById("results-area");
			const countArea = document.getElementById("results-count");
			const statsHeader = document.getElementById("stats-header");

			// 1. Load Index Stats on Startup
			window.addEventListener("DOMContentLoaded", async () => {
				try {
					const res = await fetch("/stats");
					const data = await res.json();
					statsHeader.innerText = `Index contains ${data.num_docs} documents and ${data.num_terms} unique terms.`;
				} catch (e) {
					console.log(e);
				}
			});

			// 2. Handle "Enter" key
			input.addEventListener("keypress", (e) => {
				if (e.key === "Enter") performSearch();
			});

			// 3. Search Logic
			async function performSearch() {
				const query = input.value.trim();
				if (!query) return;

				// UI Loading State
				resultsArea.innerHTML = '<div class="state-msg">Searching...</div>';
				countArea.innerText = "";

				try {
					// Fetch from Flask API with summary enabled
					const res = await fetch(
						`/search?q=${encodeURIComponent(query)}&summary=true`,
					);
					const data = await res.json();

					// Clear loading
					resultsArea.innerHTML = "";

					// Handle No Results
					if (data.count === 0) {
						resultsArea.innerHTML = `
                        <div class="state-msg">
                            <p>No results found for <strong>"${escapeHtml(data.query)}"</strong>.</p>
                            <p>Try checking your spelling or using different keywords.</p>
                        </div>
                    `;
						return;
					}

					// Show AI Summary if available
					if (data.ai_summary) {
						const summaryDiv = document.createElement("div");
						summaryDiv.className = "ai-summary";
						summaryDiv.innerHTML = `
							<h3>AI Overview</h3>
							<p>${escapeHtml(data.ai_summary)}</p>
							<div class="ai-badge">Generated by MiniSearch AI</div>
						`;
						resultsArea.appendChild(summaryDiv);
					}

					// Render Results Count
					countArea.innerText = `Found ${data.count} results`;

					// Render Results
					data.results.forEach((result) => {
						// The backend sends markdown "**text**". We convert that to HTML <strong>text</strong>
						const safeSnippet = escapeHtml(result.snippet).replace(
							/\*\*(.*?)\*\*/g,
							"<strong>$1</strong>",
						);

						const card = document.createElement("div");
						card.className = "result-card";
						card.innerHTML = `
                        <a href="${escapeHtml(result.url)}" class="result-url" target="_blank">${escapeHtml(result.url)}</a>
                        <a href="${escapeHtml(result.url)}" class="result-title" target="_blank">${escapeHtml(result.title)}</a>
                        <div class="result-snippet">${safeSnippet}</div>
                        <div class="meta-footer">
                            <span>Score: ${result.score}</span>
                            <span>Doc ID: ${result.doc_id}</span>
                        </div>
                    `;
						resultsArea.appendChild(card);
					});
				} catch (e) {
					console.error(e);
					resultsArea.innerHTML =
						'<div class="state-msg" style="color:red">Error connecting to server.</div>';
				}
			}

			// Helper to prevent XSS (Cross Site Scripting) since we are injecting HTML
			function escapeHtml(text) {
				if (!text) return "";
				return text
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/"/g, "&quot;")
					.replace(/'/g, "&#039;");
			}
		</script>
	</body>
</html>
